---
title: "Redd Distribution and Stream Temperature Evaluations for Multiple Reach Assessments"
author:
  - name: Mike Ackerman
    affiliation: Biomark, Inc.
    email: mike.ackerman@merck.com
  - name: Richie Carmichael
    affiliation: Biomark, Inc.
    email: richard.carmichael@merck.com
  - name: Kevin See
    affiliation: Biomark, Inc.
    email: kevin.see@merck.com
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  bookdown::html_document2:
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes
    fig_height: 6
    fig_width: 8
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua
  bookdown::word_document2: 
    fig_caption: yes
    fig_height: 4
    fig_width: 7
    toc: yes
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua
    reference_docx: "../templates/ReportTemplate.docx"
  bookdown::pdf_document2:
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks2.lua
    - --lua-filter=../templates/pagebreak.lua
    fig_height: 6
    fig_width: 8
    includes:
      in_header: "../templates/header_ABS.tex"
institute:
- biomark: Biomark, Inc.
csl: "../templates/american-fisheries-society.csl"
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# load knitr for markdown
library(knitr)
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
options(knitr.kable.NA = '-')
options(knitr.table.format = "pandoc")

## load necessary libraryies
library(tidyverse)
library(dplyr)
library(sf)
library(raster)
library(ggplot2)
library(readxl)
library(lubridate)
library(stringr)
library(ggpubr)
```

# Introduction

The Bureau of Reclamation (BOR), Idaho Governor's Office of Species Conservation (OSC), and an interdisciplinary team of partners have assembled an Upper Salmon Assessment Team to complete biologic and geomorphic analyses in support of future project identification, prioritization, and design in the Upper Salmon Subbasin, Idaho targeted at improving stream and riparian habitat to support imperiled Chinook salmon and steelhead populations. The biologic and geomorphic analyses are being lead by Biomark, Inc. (Biomark) and Rio Applied Science and Engineering (Rio ASE), respectively. Past efforts from the team resulted in the development of a watershed-scale Integrated Rehabilitation Assessment (IRA; Idaho OSC Team 2019) in the Lemhi, Pahsimeroi, and Upper Salmon (Sawtooth Valley) watersheds. This inital phase of the project identified the "problem" by spatially quantifying capacity limitation for spring/summer chinook salmon and summer run steelhead within a geomorphic context across these threee watersheds. The second phase, termed the Multiple Reach Assessments (MRA), includes identifying appropriate and focused "solutions" to the identified capacity problems within four valley segments: Upper Lemhi, Lower Lemhi, Lower Pahsimeroi,a nd Upper Salmon (Decker Flats). To achieve this goal, the team will collaboratively summarize existing and targeted physical habitat conditions relative to document habitat needs for specific species and life stages, including discussion of high-quality habitat, its creation, and its maintenance to inform future rehabilitation actions.

In the IRA, we determined that available spawning habitat (i.e., redd capacity) was not limiting in any of the target watersheds (Lemhi River, Pahsimeroi River, and upper Salmon River above Redfish Lake Creek) for either Chinook salmon or steelhead. Available spawning capacity was estimated as the total number of redds that each watershed could support and was estimated using quantile regression forest (QRF; Idaho OSC Team 2019, Appendix B) models and the number of redds required to support contemporary escapement or escapement to support recovery goals (e.g., minimum abundance thresholds [MAT]) was estimated using a generalized capacity model (Idaho OSC Team 2019, Appendix C). It was instead concluded that juvenile rearing habitat, during both summer and winter months, was likely limiting productivity of Chinook salmon and steelhead populations in target watersheds. Additionally, life stages not evaluated there (e.g., incubation, fry) may contribute to limited productivity in these populations. With that said, we acknowledge that future habitat actions in the target watershed should attempt to take a "do no harm" approach and minimize any negative impacts to available spawning habitat, especially in existing core spawning areas. But we believe that any appropriate actions to improve juvenile rearing will likely cause minimal or no negative impacts to spawning habitat, especially if habitat complexity (e.g., increased pool frequency with following pool-tail, riffle sequences) is considered. Additionally, if was stated in the IRA that *"providing sufficient adult holding (prespawn) habitat should be considered and would be provided by increased habitat complexity"*. Within the Lemhi, Pahsimeroi, and Upper Salmon watersheds, Chinook salmon may hold in reaches downstream or near the spawning areas in late-July and August prior to the spawning season, a time where high stream temperatures can be problematic. And finally, the Idaho OSC Team found that *"spawning habitat historically occurred farther upstream than current core ares, especially in the Upper Salmon River headwaters, effectively reducing the area currently available for rearing (i.e., area downstream of spawning).* One of the goals of this evaluation is to document the location and distribution of spawning redds in the target watersheds for recent years in which redd surveys were completed and data are available. Redd survey data were made available by the Idaho Department of Fish and Game (IDFG). Here, modeled stream temperatures available from McNyset et al. (2015) are compared to recent redd density data to determine whether temperatures are appropriate or perhaps problematic in those areas; we can also consider areas that may have historically been used for spawning.  

In Appendix A of the IRA report (Idaho OSC Team 2019), we used a combination of modeled temperature predictions (McNyset et al. 2015) and life-stage-specific temperature thresholds (Carter 2005) to evaluate whether current water temperatures might limit the ability of spring-summer run Chinook and summer run steelhead to use available habitat in the Lemhi, Pahsimeroi, and Upper Salmon watersheds. In addition, a simple warming scenario was presented (added 3&deg;C to contemporary modeled temperatures) to describe potential increases in stream temperature expected to result from climate change to assess whether the implementation of restoration actions to reduce temperatures may be necessary to aid recovery of Chinook salmon and steelhead in the watersheds. The following are the key findings from that temperature and climate change assessment:

<!--
I just spewed the below findings out using text from the IRA. Might be nice to summarize this more concisely either as like a table or just simplified under a single header.
-->

## Lemhi River

### Chinook salmon

Under current conditions, winter and early-spring modeled stream temperatures were below optimum values during egg incubation, fry emergence, juvenile winter rearing, and spring smolt emigration; this can potentially slow incubation and emergence resulting in fry emergence occurring during sub-optimal timing. Low temperatures during winter months can also cease presmolt growth or condition during winter months. Modeled summer temperatures exceed optimum values at times, potentially increasing stress during adult holding and elevating food requirements for summer parr. Under an assumed 3&deg;C increase scenario, winter and spring condtions improved somewhat, but conditions worsen for summer parr and spawners with temperatures exceeding maximum thresholds for Chinook salmon in excess of 50% of the time.

### Steelhead

Under current conditions, winter and early-spring modeled water temperatures were below optimum values for juvenile rearing and spring emigration, likely reducing juvenile growth and condition factors during winter months. Under the assumed 3&deg;C increase scenario, conditions improved for winter and spring life stages; however, conditions worsed during late-spring and summer with temperatures exceeding maximum temperature thresholds for summer juvenile rearing across much of the watershed.

## Pahsimeroi

### Chinook salmon

Under current conditions, stream temperatures in the Pahsimeroi River are rarely below optimum values. However, spring and summer temperatures tend to exceed optimum values for extended periods, potentially increasing stress on adults during staging (holding) and spawning. High spring and summer temperatures can also increase stress during incubation and emergence and increase food requirements for spring smolts and summer parr, potentially decreasing body condition. Under the assumed 3&deg;C increase scenario, conditions worsened for all summer life stages, with water temperatures above optimum for a majority of the time and potentially surpassing acute (lethal) temperatures for holding and spawning adults.

### Steelhead

Although current modeled water temperatures in the Pahsimeroi River seem to be okay for most life stages evaluated, conditons worsen under the 3&deg;C increase scenario with temperatures above optimum, maximum, or acute thresholds during spawining, incubation, emergence, spring smolt emigration, and summer parr rearing life stages.

## Upper Salmon

### Chinook salmon

Under current conditions, modeled stream temperatures are generally within optimum temperatures for each of the life stages evaluated; however, under the 3&deg;C increase scenario conditions again worsen for summer life stages including adult holding and spawning and parr rearing.

### Steelhead

Similar to Chinook salmon, modeled stream temperatures are generally within optimum temperatures for each of the life stages evaluated under current conditions. And again, most notably, under the 3&deg;C increase scenario, summer water temperatures potentially increase to above maximum during portions of spawning and summer parr rearing.

## Overall Life Stage Specific Temperature Findings from IRA

Not surprisingly, problematic stream temperature condtions were primarily identified during the extreme seasons, winter and summer. During winter and under current conditons, stream temperatures are often below optimum temperatures for juvenile winter rearing. This can results in no growth or loss of body condition prior to the spring emigration season. During summer, modeled stream temperatures were often above optimum or maximum thresholds for adult holding and spawning or summer rearing. Summer conditions worsened under the simple climate change scenario in all cases. High temperatures for adults can result in prespawn mortality or increased stress during spawning behavior. High temperatures for parr increases food requirements which increases energy expenditure to search for food and decreased growth and body conditon, potentially leading to decreased survival during fall or winter months, or forcing individuals to emigrate downstream in search for more optimal fall and winter rearing.

## Objectives

We document the location and distribution of Chinook salmon spawning in the target watersheds and compare redd density summaries to available modeled temperature results. The goal is to make available the distribution of contemporary core spawning areas, examine temperatures in those areas, and examine historic spawning areas, in a spatially explicit (i.e., by river kilometer [rkm]) framework.

Further, we want to examine stream temperatures during critical life stages for Chinook salmon and steelhead in each of the three watersheds (Lemhi, Pahsimeroi, Upper Salmon) and how they compare to temperature thresholds for those species from Carter (2005) in a spatially-explicit manner. By doing this evaluation by rkm, we can identify particular reaches within the watersheds where stream temperatures may be limiting, particularly during winter (juvenile winter rearing) and summer (adult holding, spawning, parr rearing) months identified as problematic in the IRA (Idaho OSC Team 2019).

# Methods

Method text here...

```{r read-in-data}
load("../data/mra_temp_rkm_redd_data_prepped.Rdata")

# trim year off of dates in mra_threshold
thresh_df = mra_threshold %>%
  mutate(start_date = ymd(start_date) - years(1), # converting to a non-leap year
         end_date = ymd(end_date) - years(1)) %>%
  mutate(start_julian = yday(start_date),
         end_julian = yday(end_date))

# attach rkms to the mcnyset dataset and average temps across modeled years
temp_rkm = mra_mcnyset %>%
  st_join(mra_rkm,
          join = st_nearest_feature,
          left = TRUE) %>%
  dplyr::select(-variable, -RCAID, -River) %>%
  dplyr::select(watershed, year, rkm, everything()) %>%
  arrange(watershed, rkm, year) %>%
  group_by(watershed, rkm) %>%
  summarise_at(vars(starts_with("d")), list(mean)) %>%
  ungroup() %>%
  mutate(watershed = recode(watershed, `Upper Salmon` = "Upper_Salmon"))

# a helper function I use below
round_any = function(x, accuracy, f=round){f(x/ accuracy) * accuracy}
```

```{r wtsd-spc-ls-analysis}
# set parameters to create df for wtsd-spc-ls longitudinal temp profile plots
wtsds = c("Lemhi", "Pahsimeroi", "Upper_Salmon")
spcs  = c("chinook", "steelhead")
lss   = c("adult_holding", "spawning", "incubation", "emergence",
          "summer_parr", "winter_presmolt", "spring_smolt")

# create blank data frame
all_data = NULL

# begin watershed x species x life stage loops
for(wtsd in wtsds) {
  for(spc in spcs) {
    for(ls in lss) {
    
      # start by setting rkms for the given watershed
      if(wtsd == "Lemhi")       { rkms = 0:91 }
      if(wtsd == "Pahsimeroi")  { rkms = 0:85 }
      if(wtsd == "Upper Salmon"){ rkms = 0:56 }
      
      # now, grab the thresholds for a given species x life stage
      spc_ls_thresh = thresh_df %>%
        filter(species == spc,
               life_stage == ls)
      
      # next, get the names of julians within temp_rkm that occur within species x life stage
      if(unique(spc_ls_thresh$start_julian) < unique(spc_ls_thresh$end_julian)) {
        spc_ls_julians = unique(spc_ls_thresh$start_julian):unique(spc_ls_thresh$end_julian)
      }
      if(unique(spc_ls_thresh$start_julian) > unique(spc_ls_thresh$end_julian)) {
        spc_ls_julians = c(unique(spc_ls_thresh$start_julian):365,
                           0:unique(spc_ls_thresh$end_julian))
      }
      spc_ls_julians = paste0("d", str_pad(spc_ls_julians, 3, pad = "0"))
      spc_ls_julians = spc_ls_julians[spc_ls_julians %in% colnames(temp_rkm)]
      
      # extract date_span out of life stage thresholds
      date_span = paste0(str_sub(unique(spc_ls_thresh$start_date), start = -5),
                         " to ", 
                         str_sub(unique(spc_ls_thresh$end_date), start = -5))
      
      # extract thresholds and assign as object
      for(i in 1:nrow(spc_ls_thresh)) {
        assign(as.character(spc_ls_thresh[i,"threshold"]),
               as.numeric(spc_ls_thresh[i,"temp_c"]))
      }
      
      # trim temp_rkm for watershed and columns in spc_ls_julians
      df = temp_rkm %>%
        st_drop_geometry() %>%
        filter(watershed == wtsd) %>%
        filter(rkm %in% rkms) %>%
        dplyr::select(rkm, one_of(spc_ls_julians)) %>%
        gather(key = "julian", value = "temp_c", c(-rkm)) %>%
        group_by(rkm) %>%
        summarise(mean_c = mean(temp_c),
                  min_c = min(temp_c),
                  max_c = max(temp_c),
                  sd_c = sd(temp_c),
                  n = n()) %>%
        ungroup() %>%
        mutate(watershed = wtsd,
               species = spc,
               life_stage = ls,
               min_th = minimum,
               opt_l_th = optimum_low,
               opt_h_th = optimum_high,
               max_th = maximum,
               acute_th = acute,
               ls_span = date_span) %>%
        mutate(min_obs_temp = min(min_c),
               max_obs_temp = max(max_c),
               max_rkm = max(rkm)) %>%
        mutate(label = paste(paste0(str_to_title(str_replace(life_stage, "_", " "))),
                             str_replace_all(date_span, "-", "/"),
                             sep = "\n"))
    
      all_data = rbind(all_data, df)
  
    } # end life stage loop
  } # end species loop
} # end watershed loop
```

# Results

## Lemhi River

### Chinook Salmon Redds

```{r lemh-data}
# filter, clean lemhi temp data and attach rkm data
lemh_temp_rkm_sf = mra_mcnyset %>%
  filter(watershed == "Lemhi") %>%
  dplyr::select(watershed, year, variable, RCAID, d241) %>% # day 241 = August 29
  st_join(mra_rkm,
          join = st_nearest_feature,
          left = TRUE) %>%
  dplyr::select(-River) %>%
  arrange(rkm) %>%
  group_by(rkm) %>%
  summarise(mn_max_8d_temp_d241 = mean(d241)) %>%
  filter(!rkm == "92") # an odd model estimate at confluence with Salmon R.
```

```{r lemh-temp-redd-map, fig.cap = "Map of Lemhi River showing modeled stream temperatures near the late summer spawning season for Chinook salmon and the distribution of redds (small, open black circles) available from redd surveys in recent years. Modeled temperatures are predictions for August 29 averaged across years where predictions are available."}
# map lemhi summer temps with redd locations
lemh_temp_rkm_redds_map = lemh_temp_rkm_sf %>%
  ggplot() +
  geom_sf(aes(color = mn_max_8d_temp_d241),
          size = 4) +
  scale_colour_distiller(palette = "Spectral") +
  geom_sf(data = mra_redds %>%
            filter(Waterbody == "Lemhi River"),
          size = 1,
          shape = 1) +
  theme_bw() +
  labs(title = "Lemhi River",
       colour = "Mean of 8-day Max Temps\nAug 29 (°C)" ) +
  theme(axis.title = element_blank())
lemh_temp_rkm_redds_map
```

```{r lemh-redd-map-by-year, fig.cap = "Same as figure above, except faceted by survey year to show years for which data are available and how the distribution of redds potentially changed."}
# the above, but facetted by year
lemh_temp_rkm_redds_yr_map = lemh_temp_rkm_redds_map +
  facet_wrap(~ SurveyYear) +
  theme(legend.position = 'bottom')
lemh_temp_rkm_redds_yr_map
```

```{r lemh-redds-n-temps, fig.cap = "Mean redd density (redds/km) by river kilometer in the Lemhi River averaged across years for which surveys were completed and data available. River kilometer 0 is the upstream extent of the mainstem Lemhi River and occurs at the Highway 29 bridge near Leadore and the confluence of Eighteenmile and Texas Creeks. River kilometer 91 is at the confluence with the Salmon River. A longitudinal temperature profile, with smoothed line (red), showing predictions of the mean of 8-day maximum temperatures at August 29 (averaged across available years) is also shown."}
# calculate average redds per rkm
lemh_redd_rkm = mra_redds %>%
  filter(Waterbody == "Lemhi River") %>%
  filter(Waterbody == "Lemhi River") %>%
  dplyr::select(Waterbody, Species, SurveyYear, StartDate, Longitude, Latitude) %>%
  st_join(mra_rkm,
          join = st_nearest_feature,
          left = TRUE) %>%
  group_by(rkm, SurveyYear) %>%
  summarise(n_redds = n()) %>%
  ungroup() %>%
  complete(rkm = 0:91, SurveyYear, fill = list(n_redds = 0)) %>% # need to set max rkm here
  dplyr::select(- geometry) %>%
  group_by(rkm) %>%
  summarise(mean_redds_km = mean(n_redds)) %>%
  ungroup()

# longitudinal temperature profile, with redd densities
coeff = 2.2  # for data transformation for secondary y-axis
sec_y_0 = 12 # set origin of the y-axis
lemh_temp_rkm_sf %>%
  left_join(lemh_redd_rkm) %>%
  ggplot(aes(x = rkm)) +
  geom_bar(aes(y = mean_redds_km), stat = "identity", alpha = 0.3,
           fill = "steelblue4", colour = "steelblue4") +
  geom_line(aes(y = (mn_max_8d_temp_d241 - sec_y_0) * coeff),
            size = 1.1, colour = "black") +
  geom_smooth(aes(y = (mn_max_8d_temp_d241 - sec_y_0) * coeff),
              method = "loess",
              se = F,
              size = 1, colour = "red3") +
  scale_x_continuous(breaks = seq(0, 150, by = 5)) +
  scale_y_continuous(sec.axis = sec_axis(~./coeff + sec_y_0,
                                         name = "Mean of 8-day Max Temp, Aug 29 (°C)")) +
  labs(x = "River Kilometer",
       y = "Mean Redd Density (redds/km)",
       title = "Lemhi River") +
  theme_bw()

# removing objects that begin with
rm(list = ls(pattern = "^lemh_")) # might make sense to remove this later
```

```{r lt-plot-func}
lt_plot = function(data, wtsd, spc) {
  lt_p = data %>%
    filter(watershed == wtsd,
           species == spc) %>%
    ggplot(aes(x = rkm)) +
    # longitudinal temp profile
    geom_line(aes(y = mean_c), colour = "grey40") +
    geom_smooth(aes(y = mean_c),
                method = "loess",
                colour = "black",
                se = F) +
    geom_line(aes(y = min_c), colour = "black", linetype = "dashed") +
    geom_line(aes(y = max_c), colour = "black", linetype = "dashed") +
    # min temp threshold
    geom_hline(aes(yintercept = min_th),
               colour = "blue", linetype = "longdash") +
    # optimum temp range
    geom_ribbon(aes(ymin = opt_l_th,
                    ymax = opt_h_th),
                fill = "green2",
                alpha = 0.2) +
    # max temp threshold
    geom_hline(aes(yintercept = max_th),
               colour = "red", linetype = "longdash") +
    # acute temp threshold
    geom_hline(aes(yintercept = acute_th),
               colour = "darkred") +
    # set axis breaks and limits
    scale_x_continuous(breaks = seq(0, 150, by = 5)) +
    scale_y_continuous(breaks = seq(0, 25, by = 2.5)) +
    # some formatting
    facet_wrap(~ label) +
    theme_bw() +
    labs(x = "River Kilometer",
         y = "Temperature (°C)",
         title = paste0(str_to_title(spc), ", ", wtsd))
  lt_p
}
```

### Life Stage Specific Longitudinal Temperature Profiles

#### Chinook salmon

```{r lemh-chnk-lt-plot, fig.cap = "Longitudinal temperature profiles for the mainstem Salmon River faceted by Chinook salmon life stage. The bold black line shows the mean of 8-day max temperatures among dates within the life stage and dashed black lines show the minumum and maximum 8-day values among those dates. The green ribbon shows the optimum temperature range for that life stage whereas the blue line shows the minimum temperature threshold and the red dashed and solid lines show maximum and acute temperature thresholds, respectively, for each life stage."}
lt_plot(data = all_data, wtsd = "Lemhi", spc = "chinook")
```

#### Steelhead

```{r lemh-sthd-lt-plot, fig.cap = "Longitudinal temperature profiles for the mainstem Salmon River faceted by steelhead life stage. The bold black line shows the mean of 8-day max temperatures among dates within the life stage and dashed black lines show the minumum and maximum 8-day values among those dates. The green ribbon shows the optimum temperature range for that life stage whereas the blue line shows the minimum temperature threshold and the red dashed and solid lines show maximum and acute temperature thresholds, respectively, for each life stage."}
lt_plot(data = all_data, wtsd = "Lemhi", spc = "steelhead")
```

## Pahsimeroi River

### Chinook Salmon Redds

```{r pahs-data}
# filter, clean pahsimeroi temp data and attach rkm data
pahs_temp_rkm_sf = mra_mcnyset %>%
  filter(watershed == "Pahsimeroi") %>%
  dplyr::select(watershed, year, variable, RCAID, d241) %>% # day 241 = Aug 29
  st_join(mra_rkm,
          join = st_nearest_feature,
          left = TRUE) %>%
  dplyr::select(- River) %>%
  arrange(rkm) %>%
  group_by(rkm) %>%
  summarise(mn_max_8d_temp_d241 = mean(d241)) %>%
  filter(!rkm == "86") # observation with an NA at confluence with Salmon R.
```

```{r pahs-temp-redd-map, fig.cap = "Map of Pahsimeroi River showing modeled stream temperatures near the late summer spawning season for Chinook salmon and the distribution of redds (small, open black circles) available from redd surveys in recent years. Modeled temperatures are predictions for August 29 averaged across years where predictions are available."}
# map pahs summer temps with redd locations
pahs_temp_rkm_redds_map = pahs_temp_rkm_sf %>%
  ggplot() +
  geom_sf(aes(color = mn_max_8d_temp_d241),
          size = 4) +
  scale_colour_distiller(palette = "Spectral") +
  geom_sf(data = mra_redds %>%
            filter(Waterbody == "Pahsimeroi River"),
          size = 1,
          shape = 1) +
  theme_bw() +
  labs(title = "Pahsimeroi River",
       colour = "Mean of 8-day Max Temps\nAug 29 (°C)") +
  theme(axis.title = element_blank())
pahs_temp_rkm_redds_map
# ha, note that all the redds appear to be low, presumably below the weir
# I suspect these are largely hatchery redds
```

```{r pahs-redd-map-by-year, fig.cap = "Same as figure above, except faceted by survey year to show years for which data are available and how the distribution of redds potentially changed."}
# the above, but facetted by year
pahs_temp_rkm_redds_yr_map = pahs_temp_rkm_redds_map +
  facet_wrap(~ SurveyYear) +
  theme(legend.position = 'bottom')
pahs_temp_rkm_redds_yr_map
```

```{r pahs-redds-n-temps, fig.cap = "Mean redd density (redds/km) by river kilometer in the Pahsimeroi River averaged across years for which surveys were completed and data available. River kilometer 0 is the upstream extent of the mainstem Pahsimeroi River and occurs at the confluence of the West Fork and East Fork Pahsimeroi River. River kilometer 85, the downstream extent is at the confluence with the Salmon River. A longitudinal temperature profile, with smoothed line (red), showing predictions of the mean of 8-day maximum temperatures at August 29 (averaged across available years) is also shown."}
# calculate average redds per rkm
pahs_redd_rkm = mra_redds %>%
  filter(Waterbody == "Pahsimeroi River") %>%
  dplyr::select(Waterbody, Species, SurveyYear, StartDate, Longitude, Latitude) %>%
  st_join(mra_rkm,
          join = st_nearest_feature,
          left = TRUE) %>%
  group_by(rkm, SurveyYear) %>%
  summarise(n_redds = n()) %>%
  ungroup() %>%
  complete(rkm = 0:85, SurveyYear, fill = list(n_redds = 0)) %>% # need to set max rkm here
  dplyr::select(- geometry) %>%
  group_by(rkm) %>%
  summarise(mean_redds_km = mean(n_redds)) %>%
  ungroup()

# longitudinal temperature profile, with redd densities
coeff = 2.5 # for data transformation for secondary y-axis
sec_y_0 = 11 # set origin of the y-axis
pahs_temp_rkm_sf %>%
  left_join(pahs_redd_rkm) %>%
  ggplot(aes(x = rkm)) +
  geom_bar(aes(y = mean_redds_km), stat = "identity", alpha = 0.3,
           fill = "steelblue4", colour = "steelblue4") +
  geom_line(aes(y = (mn_max_8d_temp_d241 - sec_y_0) * coeff),
            size = 1.1, colour = "black") +
  geom_smooth(aes(y = (mn_max_8d_temp_d241 - sec_y_0) * coeff),
              method = "loess",
              se = F,
              size = 1, colour = "red3") +
  scale_x_continuous(breaks = seq(0, 150, by = 5)) +
  scale_y_continuous(sec.axis = sec_axis(~./coeff + sec_y_0,
                                         name = "Mean of 8-day Max Temp, Aug 29 (°C)")) +
  labs(x = "River Kilometer",
       y = "Mean Redd Density (redds/km)",
       title = "Pahsimeroi River") +
  theme_bw()

# removing objects that begin with
rm(list = ls(pattern = "^pahs_")) # might make sense to remove this later
```

### Life Stage Specific Longitudinal Temperature Profiles

#### Chinook salmon

```{r pahs-chnk-lt-plot, fig.cap = "Longitudinal temperature profiles for the mainstem Pahsimeroi River faceted by Chinook salmon life stage. The bold black line shows the mean of 8-day max temperatures among dates within the life stage and dashed black lines show the minumum and maximum 8-day values among those dates. The green ribbon shows the optimum temperature range for that life stage whereas the blue line shows the minimum temperature threshold and the red dashed and solid lines show maximum and acute temperature thresholds, respectively, for each life stage."}
lt_plot(data = all_data, wtsd = "Pahsimeroi", spc = "chinook")
```

#### Steelhead

```{r pahs-sthd-lt-plot, fig.cap = "Longitudinal temperature profiles for the mainstem Pahsimeroi River faceted by steelhead life stage. The bold black line shows the mean of 8-day max temperatures among dates within the life stage and dashed black lines show the minumum and maximum 8-day values among those dates. The green ribbon shows the optimum temperature range for that life stage whereas the blue line shows the minimum temperature threshold and the red dashed and solid lines show maximum and acute temperature thresholds, respectively, for each life stage."}
lt_plot(data = all_data, wtsd = "Pahsimeroi", spc = "steelhead")
```

## Upper Salmon River

### Chinook Salmon Redds

```{r upsa-data}
# filter, clean upper salmon temp data and attach rkm data
upsa_temp_rkm_sf = mra_mcnyset %>%
  filter(watershed == "Upper Salmon") %>%
  dplyr::select(watershed, year, variable, RCAID, d241) %>% # day 241 = Aug 29
  st_join(mra_rkm,
          join = st_nearest_feature,
          left = TRUE) %>%
  dplyr::select(- River) %>%
  arrange(rkm) %>%
  group_by(rkm) %>%
  summarise(mn_max_8d_temp_d241 = mean(d241))
```

```{r upsa-temp-redd-map, fig.cap = "Map of Upper Salmon River (above Redfish Lake) showing modeled stream temperatures near the late summer spawning season for Chinook salmon and the distribution of redds (small, open black circles) available from redd surveys in recent years. Modeled temperatures are predictions for August 29 averaged across years where predictions are available."}
# map upsa summer temps with redd locations
# what is the easiest way to remove redds in the below plot that are x distance
# away from the mra_mcnyset line?
upsa_temp_rkm_redds_map = upsa_temp_rkm_sf %>%
  ggplot() +
  geom_sf(aes(color = mn_max_8d_temp_d241),
          size = 4) +
  scale_colour_distiller(palette = "Spectral") +
  geom_sf(data = mra_redds %>%
            filter(Waterbody == "Salmon River") %>%
            st_intersection(upsa_temp_rkm_sf %>%
                              st_make_grid(n = 1)),
          size = 1,
          shape = 1) +
  theme_bw() +
  labs(title = "Salmon River",
       colour = "Mean of 8-day Max Temps\nAug 29 (°C)") +
  theme(axis.title = element_blank(),
        axis.text.x = element_text(angle = 45,
                                   hjust = 1))
upsa_temp_rkm_redds_map
```

```{r upsa-redd-map-by-year, fig.cap = "Same as figure above, except faceted by survey year to show years for which data are available and how the distribution of redds potentially changed."}
# the above, but facetted by year
upsa_temp_rkm_redds_yr_map = upsa_temp_rkm_redds_map +
  facet_wrap(~ SurveyYear) +
  theme(legend.position = 'bottom',
        axis.text = element_text(size = 5))
upsa_temp_rkm_redds_yr_map
```

```{r upsa-redds-n-temps, fig.cap = "Mean redd density (redds/km) by river kilometer in the Upper Salmon River (above Redfish Lake Creek) averaged across years for which surveys were completed and data available. River kilometer 0 is the upstream extent of the mainstem Upper Salmon River at its source. River kilometer 56, the downstream extent, is at its confluence with Redfish Lake Creek. A longitudinal temperature profile, with smoothed line (red), showing predictions of the mean of 8-day maximum temperatures at August 29 (averaged across available years) is also shown."}
# calculate average redds per rkm
upsa_redd_rkm = mra_redds %>%
  filter(Waterbody == "Salmon River") %>%
  st_intersection(upsa_temp_rkm_sf %>%
                    st_make_grid(n = 1)) %>%
  dplyr::select(Waterbody, Species, SurveyYear, StartDate, Longitude, Latitude) %>%
  st_join(mra_rkm,
          join = st_nearest_feature,
          left = TRUE) %>%
  filter(rkm <= 56) %>%
  group_by(rkm, SurveyYear) %>%
  summarise(n_redds = n()) %>%
  ungroup() %>%
  complete(rkm = 0:56, SurveyYear, fill = list(n_redds = 0)) %>% # need to set max rkm here
  dplyr::select(- geometry) %>%
  group_by(rkm) %>%
  summarise(mean_redds_km = mean(n_redds)) %>%
  ungroup()

# longitudinal temperature profile, with redd densities
coeff = 14 # for data transformation for secondary y-axis
sec_y_0 = 12.5
upsa_temp_rkm_sf %>%
  left_join(upsa_redd_rkm) %>%
  ggplot(aes(x = rkm)) +
  geom_bar(aes(y = mean_redds_km), stat = "identity", alpha = 0.3,
           fill = "steelblue4", colour = "steelblue4") +
  geom_line(aes(y = (mn_max_8d_temp_d241 - sec_y_0) * coeff),
            size = 1.1, colour = "black") +
  geom_smooth(aes(y = (mn_max_8d_temp_d241 - sec_y_0) * coeff),
              method = "loess",
              se = F,
              size = 1, colour = "red3") +
  scale_x_continuous(breaks = seq(0, 150, by = 5)) +
  scale_y_continuous(sec.axis = sec_axis(~./coeff + sec_y_0,
                                         name = "Mean of 8-day Max Temp, Aug 29 (°C)")) +
  labs(x = "River Kilometer",
       y = "Mean Redd Density (redds/km)",
       title = "Upper Salmon River") +
  theme_bw()

# removing objects that begin with
rm(list = ls(pattern = "^upsa_")) # might make sense to remove this later
```

### Life Stage Specific Longitudinal Temperature Profiles

#### Chinook salmon

```{r upsa-chnk-lt-plot, fig.cap = "Longitudinal temperature profiles for the mainstem Upper Salmon River (above Redfish Lake Creek) faceted by Chinook salmon life stage. The bold black line shows the mean of 8-day max temperatures among dates within the life stage and dashed black lines show the minumum and maximum 8-day values among those dates. The green ribbon shows the optimum temperature range for that life stage whereas the blue line shows the minimum temperature threshold and the red dashed and solid lines show maximum and acute temperature thresholds, respectively, for each life stage."}
lt_plot(data = all_data, wtsd = "Upper_Salmon", spc = "chinook")
```

#### Steelhead

```{r upsa-sthd-lt-plot, fig.cap = "Longitudinal temperature profiles for the mainstem Upper Salmon River (above Redfish Lake Creek) faceted by steelhead life stage. The bold black line shows the mean of 8-day max temperatures among dates within the life stage and dashed black lines show the minumum and maximum 8-day values among those dates. The green ribbon shows the optimum temperature range for that life stage whereas the blue line shows the minimum temperature threshold and the red dashed and solid lines show maximum and acute temperature thresholds, respectively, for each life stage."}
lt_plot(data = all_data, wtsd = "Upper_Salmon", spc = "steelhead")
```

# Discussion

Do some serious hand-waving here...

## Conclusions

The hard-hitting stuff...

# Literature Cited

Carter, K. 2005. The effects of temperature on steelhead trout, Coho salmon, and Chinook salmon biology and function by life stage. Implications for Klamath Basin TMDLs. California Regional Water Quality Control Board. North Coast Region. 26 pp.

Idaho OSC Team (Idaho Governor’s Office of Species Conservation and partners). 2019. Upper Salmon Subbasin Habitat Integrated Rehabilitation Assessment. Assessment prepared for and with the U.S. Department of the Interior, Bureau of Reclamation. June 2019. 625 pp.

McNyset, K.M., C.J. Volk, and C.E. Jordan. 2015. Developing an effective model for predicting spatially and temporally continuous stream temperatures from remotely sensed land surface temperatures. Water. 7:6827-6846.
